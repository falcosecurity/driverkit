# This is a reusable workflow used by master and release CI
on:
  workflow_call:
    inputs:
      arch:
        description: amd64 or arm64
        required: true
        type: string

jobs:
  build-test:
    # See https://github.com/actions/runner/issues/409#issuecomment-1158849936
    runs-on: ${{ (inputs.arch == 'arm64' && 'actuated-arm64-8cpu-16gb') || 'ubuntu-latest' }}
    container: golang:1.21-alpine
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: apk add gcc musl-dev make bash git binutils-gold

      - name: Build
        run: make build
        
      - name: Test
        run: make test
      
      - name: Integration tests
        run: make integration_test
        
      - name: Upload driverkit
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # v3.1.3
        with:
          name: driverkit-${{ inputs.arch }}
          path: |
            ${{ github.workspace }}/_output/bin/driverkit
