version: 2
jobs:
  "test":
    docker:
      - image: docker.io/golang:alpine3.11
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache --update
            apk add make bash git
      - run:
          name: Test
          command: make test
  "images":
    docker:
      - image: docker:stable
    steps:
      - attach_workspace:
          at: /
      - checkout
      - setup_remote_docker
      - run:
          name: Prepare docker env
          command: echo ${DOCKERHUB_SECRET} | docker login -u ${DOCKERHUB_USER} --password-stdin
      - run:
          name: Build all the docker images
          command: make image/all
      - run:
          name: Push images
          command: |
            make push/builder
            make push/driverkit
      - run:
          name: Push latest images
          command: make push/latest
workflows:
  version: 2
  build:
    jobs:
      - "test"
      - "images":
          context: falco
          filters:
            branches:
              only:
                - master
          requires:
            - "test"
